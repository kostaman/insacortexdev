#!/bin/bash

GEN_SOURCE_NAME=tpl_invoque.S

cat << EOF > $GEN_SOURCE_NAME
/**
 * @file tpl_invoque.S
 *
 * @section descr File description
 *
 * System call user level invoque API.
 *
 * @warning this file is generated by gen_invoque.sh based on the 
 * tpl_os_service_ids.h header file.
 *
 * @section copyright Copyright
 *
 * Trampoline OS
 *
 * Trampoline is copyright (c) IRCCyN 2005+
 * Copyright ESEO for function and data structures documentation and ARM port
 * Trampoline is protected by the French intellectual property law.
 *
 * This software is distributed under the Lesser GNU Public Licence
 *
 * @section infos File informations
 *
 * \$Date$
 * \$Rev$
 * \$Author$
 * \$URL$
 */
#include "tpl_os_application_def.h"
#include "tpl_os_service_ids.h"

#ifndef WITH_SYSTEM_CALL
#error "This file should not be part of your project since WITH_SYSTEM_CALL is not defined"
#endif

#ifdef WITH_SYSTEM_CALL

EOF

egrep "define.*OSServiceId_" ../../os/tpl_os_service_ids.h | sed -e 's/.*OSServiceId_\([^ ]*\).*/\1/' | sed -e 's/\(.*\)/\.global \1\n\1:\n  mov r3, #OSServiceId_\1\n  swi #OSServiceId_\1\n  mov pc, lr\n/' | cat >> $GEN_SOURCE_NAME

echo "#endif /* defined WITH_SYSTEM_CALL */" >> $GEN_SOURCE_NAME

sed -e '/mov r3, #OSServiceId_StartOS/d;s/\(swi #OSServiceId_StartOS\)/stmfd sp!, {r0} \/\* saves StartOS parameter \*\/\n  bl tpl_init_machine\n  ldmfd sp!, {r0}\n  mov r3, #OSServiceId_StartOS\n  \1\n  bl tpl_sleep/' $GEN_SOURCE_NAME > $GEN_SOURCE_NAME.tmp

mv $GEN_SOURCE_NAME.tmp $GEN_SOURCE_NAME
